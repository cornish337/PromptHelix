{% extends "base.html" %}

{% block title %}Real-Time Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Real-Time Monitoring Dashboard</h1>

    <!-- GA Progress Section -->
    <section id="ga-progress" class="mb-6 p-4 bg-white rounded shadow border border-gray-200">
        <h2 class="text-xl font-semibold mb-3">Genetic Algorithm Progress</h2>
        <div id="ga-progress-data">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 mb-4">
                <div>
                    <span class="font-semibold text-gray-700">GA Status:</span>
                    <span id="ga-status" class="text-gray-900">Idle</span>
                </div>
                <div>
                    <span class="font-semibold text-gray-700">Current Generation:</span>
                    <span id="ga-generation" class="text-gray-900">-</span>
                </div>
                <div>
                    <span class="font-semibold text-gray-700">Best Fitness:</span>
                    <span id="ga-best-fitness" class="text-gray-900">-</span>
                </div>
                <div>
                    <span class="font-semibold text-gray-700">Agents Used:</span>
                    <span id="ga-agents-used" class="text-gray-900">-</span>
                </div>
                <div class="md:col-span-2">
                    <span class="font-semibold text-gray-700">Fittest Chromosome:</span>
                    <pre id="ga-fittest-chromosome" class="text-gray-900 bg-gray-100 p-2 rounded mt-1 overflow-x-auto">-</pre>
                </div>
            </div>
            <div class="mt-4 flex space-x-2">
                <button id="ga-pause-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150 ease-in-out">Pause</button>
                <button id="ga-resume-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150 ease-in-out">Resume</button>
                <button id="ga-cancel-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150 ease-in-out">Cancel</button>
            </div>
            <!-- Placeholder for charts -->
            <div id="ga-charts-placeholder" class="mt-4 p-8 bg-gray-50 border border-gray-300 border-dashed rounded-md text-center text-gray-500">
                Chart will appear here.
            </div>
        </div>
    </section>

    <!-- Conversation Logs Section -->
    <section id="conversation-logs" class="mb-6 p-4 bg-white rounded shadow border border-gray-200">
        <h2 class="text-xl font-semibold mb-3">Live Conversation Logs</h2>
        <div id="logs-container" class="max-h-96 overflow-y-auto space-y-2 pr-2 border rounded p-2 bg-gray-50">
            <!-- Logs will be appended here by JavaScript -->
            <div class="log-entry text-gray-500">Waiting for logs...</div>
        </div>
    </section> <!-- Conversation Logs Section -->

    <!-- Debug Logs Section -->
    <section id="debug-logs" class="mb-6 p-4 bg-white rounded shadow border border-gray-200">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-semibold">Real-Time Debug Logs</h2>
            <div class="flex items-center">
                <input type="checkbox" id="toggle-debug-logs" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" checked>
                <label for="toggle-debug-logs" class="ml-2 text-sm text-gray-700">Show Debug Logs</label>
            </div>
        </div>
        <div id="debug-logs-container" class="max-h-96 overflow-y-auto space-y-2 pr-2 border rounded p-2 bg-gray-50">
            <!-- Debug logs will be appended here by JavaScript -->
            <div class="log-entry text-gray-500">Waiting for debug logs...</div>
        </div>
    </section>

    <!-- Agent Metrics Section -->
    <section id="agent-metrics" class="p-4 bg-white rounded shadow border border-gray-200">
        <h2 class="text-xl font-semibold mb-3">Agent Metrics</h2>
        <div id="agent-metrics-data">
            <p>Metrics will appear here.</p>
            <!-- Placeholder for metrics display -->
        </div>
    </section>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const gaStatus = document.getElementById('ga-status');
        const gaGeneration = document.getElementById('ga-generation');
        const gaBestFitness = document.getElementById('ga-best-fitness');
        const gaAgentsUsed = document.getElementById('ga-agents-used'); // Added
        const gaFittestChromosome = document.getElementById('ga-fittest-chromosome'); // Added
        const logsContainer = document.getElementById('logs-container');
        const agentMetricsData = document.getElementById('agent-metrics-data');
        const debugLogsContainer = document.getElementById('debug-logs-container'); // Add this
        const toggleDebugLogs = document.getElementById('toggle-debug-logs'); // Add this

        const gaPauseBtn = document.getElementById('ga-pause-btn');
        const gaResumeBtn = document.getElementById('ga-resume-btn');
        const gaCancelBtn = document.getElementById('ga-cancel-btn');

        // Function to handle GA data updates from WebSocket
        function handleGaDataUpdate(data) {
            gaStatus.textContent = data.status || 'N/A';
            updateStatusBadge(gaStatus.textContent);
            gaGeneration.textContent = data.generation || '-';
            gaBestFitness.textContent = data.best_fitness ? parseFloat(data.best_fitness).toFixed(4) : '-';

            if (data.agents_used && Array.isArray(data.agents_used)) {
                gaAgentsUsed.textContent = data.agents_used.join(', ') || 'N/A';
            } else {
                gaAgentsUsed.textContent = 'N/A';
            }
            gaFittestChromosome.textContent = data.fittest_chromosome_string || 'N/A';
            updateGaControlButtons(data.status);
            console.log("GA Data Processed for event type, data:", data); // Modified console log
        }

        function updateStatusBadge(statusText) {
            const statusElement = document.getElementById('ga-status');
            if (!statusElement) return;

            // Remove existing color classes and base styling classes to avoid accumulation
            const classesToRemove = Array.from(statusElement.classList).filter(cls =>
                cls.startsWith('bg-') || cls.startsWith('text-') ||
                ['px-2.5', 'py-1', 'rounded-md', 'text-xs', 'font-semibold', 'inline-block'].includes(cls)
            );
            statusElement.classList.remove(...classesToRemove);

            // Add base styling for the badge
            statusElement.classList.add('px-2.5', 'py-1', 'rounded-md', 'text-xs', 'font-semibold', 'inline-block');

            if (!statusText) statusText = 'IDLE'; // Default if undefined or null

            switch (statusText.toUpperCase()) {
                case 'RUNNING':
                    statusElement.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'PAUSED':
                    statusElement.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'INITIALIZING':
                case 'STOPPING':
                    statusElement.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                case 'ERROR':
                    statusElement.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'IDLE':
                case 'COMPLETED':
                case 'CANCELLED': // Assuming CANCELLED is a possible status
                default:
                    statusElement.classList.add('bg-gray-100', 'text-gray-800');
                    break;
            }
        }

        function updateGaControlButtons(gaStatusString) {
            const status = gaStatusString ? gaStatusString.toUpperCase() : 'IDLE';
            if (!gaPauseBtn || !gaResumeBtn || !gaCancelBtn) return; // Buttons not found

            // Default states
            gaPauseBtn.disabled = true;
            gaResumeBtn.disabled = true;
            gaCancelBtn.disabled = true;

            if (status === 'RUNNING') {
                gaPauseBtn.disabled = false;
                gaCancelBtn.disabled = false;
            } else if (status === 'PAUSED') {
                gaResumeBtn.disabled = false;
                gaCancelBtn.disabled = false;
            } else if (status === 'INITIALIZING' || status === 'STOPPING') {
                // All buttons disabled while initializing or stopping
                gaCancelBtn.disabled = false; // Allow cancelling if stuck in initializing/stopping
            }
            // For IDLE, COMPLETED, STOPPED, ERROR, all remain disabled (default)
        }

        async function fetchInitialGaStatus() {
            try {
                const response = await fetch('/api/ga/status');
                if (response.ok) {
                    const statusData = await response.json();
                    console.log('Initial GA Status:', statusData);
                    // Update UI elements based on this initial status
                    gaStatus.textContent = statusData.status || 'N/A'; // Set text first
                    updateStatusBadge(gaStatus.textContent); // Then update badge based on the new text
                    gaGeneration.textContent = statusData.generation || '-';
                    gaBestFitness.textContent = statusData.best_fitness ? parseFloat(statusData.best_fitness).toFixed(4) : '-';
                    if (statusData.agents_used && Array.isArray(statusData.agents_used)) {
                        gaAgentsUsed.textContent = statusData.agents_used.join(', ') || 'N/A';
                    } else {
                        gaAgentsUsed.textContent = 'N/A';
                    }
                    gaFittestChromosome.textContent = statusData.fittest_chromosome_string || 'N/A';

                    updateGaControlButtons(statusData.status);
                } else {
                    console.error('Failed to fetch initial GA status:', response.status);
                    gaStatus.textContent = 'Error'; // Update text before badge
                    updateStatusBadge('Error');
                    updateGaControlButtons('ERROR'); // Assume error if status fetch fails
                }
            } catch (error) {
                console.error('Error fetching initial GA status:', error);
                gaStatus.textContent = 'Error'; // Update text before badge
                updateStatusBadge('Error');
                updateGaControlButtons('ERROR'); // Assume error on error
            }
        }

        // Determine WebSocket protocol
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/dashboard`;

        console.log(`Attempting to connect to WebSocket at: ${wsUrl}`);
        const socket = new WebSocket(wsUrl);

        socket.onopen = function(event) {
            console.log("WebSocket connection established.");
            logsContainer.innerHTML = '<div class="log-entry text-green-600">Connected to real-time updates.</div>';
            socket.send(JSON.stringify({ message: "Hello Server from Dashboard!" }));
        };

        socket.onmessage = function(event) {
            console.log("WebSocket message received:", event.data);
            const message = JSON.parse(event.data);

            if (message.type === 'new_conversation_log' && message.data) {
                const logEntry = document.createElement('div');
                logEntry.classList.add('log-entry', 'p-2', 'rounded', 'text-xs', 'mb-1');

                // Basic styling based on sender/recipient (can be refined)
                if (message.data.sender_id && message.data.sender_id.toLowerCase().includes('agent')) {
                    logEntry.classList.add('bg-blue-50');
                } else if (message.data.sender_id === 'SYSTEM') {
                    logEntry.classList.add('bg-yellow-50');
                } else {
                    logEntry.classList.add('bg-gray-100');
                }

                const timestamp = new Date(message.data.timestamp || Date.now()).toLocaleTimeString();
                let contentHtml = '';
                if (typeof message.data.content === 'object') {
                    contentHtml = `<pre class="whitespace-pre-wrap">${JSON.stringify(message.data.content, null, 2)}</pre>`;
                } else {
                    contentHtml = `<p class="whitespace-pre-wrap">${message.data.content}</p>`;
                }

                logEntry.innerHTML = `
                    <div class="font-semibold">${timestamp} | ${message.data.sender_id} &rarr; ${message.data.recipient_id || 'BROADCAST'} (${message.data.message_type})</div>
                    <div class="pl-2">${contentHtml}</div>
                    <div class="text-gray-500 text-right text-xs">Session: ${message.data.session_id}</div>
                `;

                // If it was "Waiting for logs...", remove it
                const waitingMsg = logsContainer.querySelector('.text-gray-500');
                if (waitingMsg && waitingMsg.textContent === 'Waiting for logs...') {
                    logsContainer.innerHTML = '';
                }
                const connectedMsg = logsContainer.querySelector('.text-green-600');
                 if (connectedMsg && connectedMsg.textContent === 'Connected to real-time updates.') {
                    logsContainer.innerHTML = ''; // Clear "Connected..." message on first actual log
                }


                logsContainer.appendChild(logEntry);
                logsContainer.scrollTop = logsContainer.scrollHeight; // Auto-scroll
            } else if (message.type === 'debug_log' && message.data) {

                // REMOVED: const debugLogsContainer = document.getElementById('debug-logs-container');
                // REMOVED: const toggleDebugLogs = document.getElementById('toggle-debug-logs');

                // Use the 'toggleDebugLogs' and 'debugLogsContainer' from the outer scope (DOMContentLoaded)

                if (toggleDebugLogs && toggleDebugLogs.checked) {
                    const logEntry = document.createElement('div');
                    logEntry.classList.add('log-entry', 'p-1', 'rounded', 'text-xs', 'mb-1', 'font-mono'); // Added font-mono

                    const level = message.data.level ? message.data.level.toLowerCase() : 'info';
                    if (level === 'error') {
                        logEntry.classList.add('bg-red-50', 'text-red-700');
                    } else if (level === 'warning') {
                        logEntry.classList.add('bg-yellow-50', 'text-yellow-700');
                    } else if (level === 'debug') {
                        logEntry.classList.add('bg-blue-50', 'text-blue-700');
                    } else {
                        logEntry.classList.add('bg-gray-100');
                    }

                    const timestamp = new Date(message.data.timestamp * 1000).toLocaleTimeString();
                    const logMessage = message.data.message || '';
                    const module = message.data.module || 'unknown_module';
                    const funcName = message.data.funcName || 'unknown_function';
                    const lineno = message.data.lineno || '?';

                    logEntry.innerHTML = `
                        <div class="grid grid-cols-12 gap-x-1">
                            <span class="col-span-2 text-gray-600">${timestamp}</span>
                            <span class="col-span-1 font-semibold ${level === 'error' || level === 'warning' ? '' : 'text-gray-700'}">${message.data.level}</span>
                            <span class="col-span-3 text-purple-600">${module}.${funcName}:${lineno}</span>
                            <span class="col-span-6">${logMessage}</span>
                        </div>
                    `;

                    const waitingMsg = debugLogsContainer.querySelector('.text-gray-500');
                    if (waitingMsg && waitingMsg.textContent === 'Waiting for debug logs...') {
                        debugLogsContainer.innerHTML = '';
                    }
                    debugLogsContainer.appendChild(logEntry);
                    debugLogsContainer.scrollTop = debugLogsContainer.scrollHeight; // Auto-scroll
                }
            } else if ((message.type === 'ga_update' || message.type === 'ga_evaluation_complete' || message.type === 'ga_generation_complete' || message.type === 'ga_status_update') && message.data) {
                handleGaDataUpdate(message.data);
            } else if (message.type === 'agent_metric_update' && message.data) {
                const metricsData = message.data;
                const agentId = metricsData.agent_id;
                const metricsContainer = document.getElementById('agent-metrics-data');

                // Find or create a div for this agent's metrics
                let agentDiv = document.getElementById(`agent-metric-${agentId}`);
                if (!agentDiv) {
                    agentDiv = document.createElement('div');
                    agentDiv.id = `agent-metric-${agentId}`;
                    agentDiv.classList.add('agent-metric-entry', 'p-2', 'mb-2', 'border', 'rounded', 'bg-gray-50');

                    // If it's the first metric entry, clear the placeholder "Metrics will appear here."
                    const placeholder = metricsContainer.querySelector('p');
                    if (placeholder && placeholder.textContent === 'Metrics will appear here.') {
                        metricsContainer.innerHTML = '';
                    }
                    metricsContainer.appendChild(agentDiv);
                }

                // Update the content of the agent's div
                agentDiv.innerHTML = `
                    <h4 class="font-semibold text-md">${agentId}</h4>
                    <p class="text-sm">Messages Processed: <span class="font-medium">${metricsData.messages_processed}</span></p>
                    <p class="text-sm">Errors Encountered: <span class="font-medium text-red-600">${metricsData.errors_encountered}</span></p>
                    <p class="text-xs text-gray-500">Last updated: ${new Date(metricsData.timestamp).toLocaleTimeString()}</p>
                `;
            } else if (message.message) { // For generic messages like connection acks
                 const infoEntry = document.createElement('div');
                 infoEntry.classList.add('log-entry', 'p-1', 'text-sm', 'text-gray-600', 'italic');
                 infoEntry.textContent = `System: ${message.message}`;
                 logsContainer.appendChild(infoEntry);
                 logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            // Add more handlers for other message types (agent_metrics, etc.)
        };

        socket.onerror = function(error) {
            console.error("WebSocket Error:", error);
            const errorEntry = document.createElement('div');
            errorEntry.classList.add('log-entry', 'text-red-600');
            errorEntry.textContent = 'WebSocket connection error. See console for details.';
            logsContainer.appendChild(errorEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        };

        socket.onclose = function(event) {
            console.log("WebSocket connection closed:", event);
            const closeEntry = document.createElement('div');
            closeEntry.classList.add('log-entry', 'text-orange-600');
            if (event.wasClean) {
                closeEntry.textContent = `WebSocket connection closed cleanly, code=${event.code} reason=${event.reason}`;
            } else {
                closeEntry.textContent = 'WebSocket connection died.';
            }
            logsContainer.appendChild(closeEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        };

        // Event Listeners for GA Control Buttons
        if (gaPauseBtn) {
            gaPauseBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/ga/pause', { method: 'POST' });
                    const result = await response.json();
                    console.log('Pause response:', result);
                    // Optionally, show a small notification here e.g. using a toast library
                    // UI will update via WebSocket 'ga_update' message
                } catch (error) {
                    console.error('Error pausing GA:', error);
                    // Show error notification
                }
            });
        }

        if (gaResumeBtn) {
            gaResumeBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/ga/resume', { method: 'POST' });
                    const result = await response.json();
                    console.log('Resume response:', result);
                } catch (error) {
                    console.error('Error resuming GA:', error);
                }
            });
        }

        if (gaCancelBtn) {
            gaCancelBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/ga/cancel', { method: 'POST' });
                    const result = await response.json();
                    console.log('Cancel response:', result);
                } catch (error) {
                    console.error('Error cancelling GA:', error);
                }
            });
        }

        // Set initial state for buttons and fetch initial status
        // updateGaControlButtons('IDLE'); // This will be set by fetchInitialGaStatus
        // updateStatusBadge('IDLE'); // Also set by fetchInitialGaStatus
        fetchInitialGaStatus(); // Fetch current status on load

    });
</script>
{% endblock %}
