{% extends "base.html" %}

{% block title %}LLM Tester - PromptHelix{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">LLM Test Interface</h1>

    {% if error_message %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
        <strong class="font-bold">Error:</strong>
        <span class="block sm:inline">{{ error_message }}</span>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- LLM Test Form -->
        <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <h2 class="text-xl font-semibold mb-3">Send Test Prompt</h2>
            <form id="llmTestForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="llm_service">
                        Select LLM Service
                    </label>
                    <select id="llm_service" name="llm_service"
                            class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        {% if available_llms %}
                            {% for service in available_llms %}
                            <option value="{{ service }}">{{ service }}</option>
                            {% endfor %}
                        {% else %}
                            <option value="">No LLMs available (check API keys in settings)</option>
                        {% endif %}
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="prompt_text">
                        Prompt Text
                    </label>
                    <textarea id="prompt_text" name="prompt_text" rows="10"
                              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
                              placeholder="Enter your prompt here..."></textarea>
                </div>
                <div class="flex items-center justify-between">
                    <button id="submitPrompt"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            type="submit">
                        Send Prompt
                    </button>
                </div>
            </form>
        </div>

        <!-- LLM Response Display -->
        <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <h2 class="text-xl font-semibold mb-3">LLM Response</h2>
            <div id="llmResponseDisplay" class="bg-gray-100 p-4 rounded min-h-[200px] whitespace-pre-wrap">
                {% if llm_response %}
                    <p><strong>Service:</strong> {{ llm_response.llm_service }}</p>
                    <p><strong>Response:</strong></p>
                    <p>{{ llm_response.response_text }}</p>
                {% else %}
                    <p>Response will appear here...</p>
                {% endif %}
            </div>
            <div id="responseSpinner" class="hidden text-center mt-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                <p>Loading response...</p>
            </div>
        </div>
    </div>

    <!-- Statistics Display -->
    <div class="mt-8 bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
        <h2 class="text-xl font-semibold mb-3">LLM Usage Statistics</h2>
        <div id="statisticsDisplay">
            {% if statistics %}
            <table class="min-w-full table-auto">
                <thead>
                    <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">LLM Service</th>
                        <th class="py-3 px-6 text-left">Request Count</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 text-sm font-light">
                    {% for stat in statistics %}
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6 text-left whitespace-nowrap">{{ stat.llm_service }}</td>
                        <td class="py-3 px-6 text-left">{{ stat.request_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No statistics available yet.</p>
            {% endif %}
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('llmTestForm');
        const responseDisplay = document.getElementById('llmResponseDisplay');
        const statisticsDisplay = document.getElementById('statisticsDisplay');
        const submitButton = document.getElementById('submitPrompt');
        const responseSpinner = document.getElementById('responseSpinner');
        const llmServiceSelect = document.getElementById('llm_service');

        // Function to fetch and update statistics
        async function fetchStatistics() {
            try {
                const response = await fetch("{{ request.url_for('get_llm_statistics') }}");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const statsData = await response.json();

                let statsHtml = '<p>No statistics available yet.</p>';
                if (statsData && statsData.length > 0) {
                    statsHtml = `
                        <table class="min-w-full table-auto">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">LLM Service</th>
                                    <th class="py-3 px-6 text-left">Request Count</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light">`;
                    statsData.forEach(stat => {
                        statsHtml += \`
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left whitespace-nowrap">\${stat.llm_service}</td>
                                <td class="py-3 px-6 text-left">\${stat.request_count}</td>
                            </tr>\`;
                    });
                    statsHtml += '</tbody></table>';
                }
                statisticsDisplay.innerHTML = statsHtml;
            } catch (error) {
                console.error("Error fetching statistics:", error);
                statisticsDisplay.innerHTML = "<p class='text-red-500'>Error loading statistics.</p>";
            }
        }

        // Function to fetch and update available LLMs (e.g. if keys change)
        // Not strictly necessary for this version if page reloads/re-renders often enough
        // but good for robustness if settings can change without full page reload.
        async function fetchAvailableLLMs() {
            try {
                const response = await fetch("{{ request.url_for('get_available_llms') }}");
                if (!response.ok) {
                    throw new Error(\`HTTP error! status: \${response.status}\`);
                }
                const llmsData = await response.json();

                let optionsHtml = '<option value="">No LLMs available</option>';
                if (llmsData && llmsData.length > 0) {
                    optionsHtml = llmsData.map(service => \`<option value="\${service}">\${service}</option>\`).join('');
                }
                llmServiceSelect.innerHTML = optionsHtml;
            } catch (error) {
                console.error("Error fetching available LLMs:", error);
                llmServiceSelect.innerHTML = "<option value=''>Error loading LLMs</option>";
            }
        }

        // Initial fetch of LLMs (can be useful if settings change and UI is reloaded via JS)
        // fetchAvailableLLMs(); // Commented out as initial data is passed from server-side render

        form.addEventListener('submit', async function (event) {
            event.preventDefault();
            submitButton.disabled = true;
            responseSpinner.classList.remove('hidden');
            responseDisplay.innerHTML = '<p>Processing...</p>';

            const formData = new FormData(form);
            const data = {
                llm_service: formData.get('llm_service'),
                prompt_text: formData.get('prompt_text')
            };

            try {
                const response = await fetch("{{ request.url_for('test_llm_prompt') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Include CSRF token if your app uses them for POST requests
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || \`HTTP error! status: \${response.status}\`);
                }

                const result = await response.json();
                responseDisplay.innerHTML = \`
                    <p><strong>Service:</strong> \${result.llm_service}</p>
                    <p><strong>Response:</strong></p>
                    <div class="whitespace-pre-wrap">\${result.response_text}</div>\`;

                // Refresh statistics after successful prompt
                fetchStatistics();

            } catch (error) {
                console.error('Error sending prompt:', error);
                responseDisplay.innerHTML = \`<p class="text-red-500"><strong>Error:</strong> \${error.message}</p>\`;
            } finally {
                submitButton.disabled = false;
                responseSpinner.classList.add('hidden');
            }
        });

        // Initial fetch of statistics on page load
        // fetchStatistics(); // Already rendered server-side, but can be enabled for dynamic updates
    });
</script>
{% endblock %}
